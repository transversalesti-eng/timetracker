<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TIC Tranversales - Registro de Tiempos</title>
  <link rel="icon" href="Acciona_logo.svg.png" />

  <style>
  .table-wrap{ overflow-x:auto; border:1px solid #eee; border-radius:10px; }
  .table{ width:100%; border-collapse:collapse; font-size:14px; }
  .table thead th{ position:sticky; top:0; background:#fff0f1; color:var(--acciona); text-align:left; padding:10px; border-bottom:2px solid #f2b4b8; }
  .table tbody td{ padding:10px; border-bottom:1px solid #f2f2f2; vertical-align:top; }
  .table tfoot td{ padding:10px; background:#f9f9f9; font-weight:700; }
  .table tbody tr:hover{ background:#fff8f8; }
    :root{--acciona:#e30613;--acciona-dark:#ba0510;--ok:#1a7f37;--error:#a40000;}
    *{box-sizing: border-box;}
    body {font-family: 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;background:#f6f7f8;margin:0;color:#222;}
    .container { max-width: 1000px; margin: 24px auto; padding: 24px; background:#fff; border-radius: 14px; box-shadow: 0 10px 25px rgba(0,0,0,.06); }
    .logo { display:flex; justify-content:center; margin-bottom: 8px; }
    .logo img { height: 76px; }
    h1 { text-align:center; color: var(--acciona); margin: 8px 0 24px; letter-spacing:.2px; }

    label { font-weight: 600; color:#333; }
    .form-row { display:flex; gap:16px; flex-wrap: wrap; }
    .form-group { margin-bottom: 16px; flex:1; min-width: 220px; }
    select, input, textarea { width:100%; padding:10px 12px; margin-top:6px; border:1px solid #d9d9d9; border-radius:8px; font-size:15px; background:#fff; transition: .2s border, .2s box-shadow; }
    select:focus, input:focus, textarea:focus { border-color: var(--acciona); outline: none; box-shadow: 0 0 0 3px rgba(227,6,19,.15); }

    .activity-block { border:2px solid var(--acciona); border-radius:12px; padding:16px; background:#fff; margin-bottom:16px; }
    .activity-block h3 { margin:0 0 12px; }
    .badge { display:inline-block; background:#fff0f1; color:var(--acciona); padding:6px 10px; border-radius:999px; font-weight:700; }

    .entry { background:#fff; border:1px solid #eee; border-left:4px solid var(--acciona); padding:12px; border-radius:8px; margin-bottom:10px; display:flex; flex-wrap:wrap; gap:8px 16px; align-items:center; }
    .entry .meta { flex:1 1 200px; }
    .entry .row-actions { display:flex; gap:8px; }

    .btn { background: var(--acciona); color:#fff; padding:10px 16px; border:none; border-radius:8px; font-weight:700; cursor:pointer; transition: .2s background, .2s transform; }
    .btn:hover { background: var(--acciona-dark); }
    .btn:active { transform: translateY(1px); }
    .btn-secondary { background:#fff; color:var(--acciona); border:2px solid var(--acciona); }
    .btn-secondary:hover { background:#ffe6e8; }

    .actions-bar { position: sticky; bottom:0; background:#ffffffd9; backdrop-filter:saturate(180%) blur(4px); display:flex; gap:12px; padding:12px; margin-top:8px; border-top:1px solid #eee; border-radius:0 0 12px 12px; }

    .summary { background:#f7f7f7; border:1px solid #eee; padding:10px 12px; border-radius:8px; font-size: 14px; }
    .summary.ok { border-color:#cfe9d6; background:#f4fbf6; color: var(--ok); }
    .summary.bad { border-color:#ffb3b3; background:#fff4f4; color: var(--error); }

    .error { background:#ffecec; color:var(--error); border-left:4px solid var(--error); padding:10px 12px; border-radius:8px; display:none; margin-top:10px; }

    #feedback { position: fixed; top: 20px; right: 20px; padding: 12px 16px; background: #e0f7e9; color: var(--ok); border-left:4px solid var(--ok); border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,.1); font-weight: 700; display:none; z-index: 1000; opacity:0; transform: translateY(-6px); transition: .25s opacity, .25s transform; }
    #feedback.visible { display:block; opacity:1; transform: translateY(0); }
.table-wrap{ overflow-x:auto; border:1px solid #eee; border-radius:10px; }
.table{ width:100%; border-collapse:collapse; font-size:14px; }
.table thead th{ position:sticky; top:0; background:#fff0f1; color:var(--acciona); text-align:left; padding:10px; border-bottom:2px solid #f2b4b8; }
.table tbody td{ padding:10px; border-bottom:1px solid #f2f2f2; vertical-align:top; }
.table tfoot td{ padding:10px; background:#f9f9f9; font-weight:700; }
.table tbody tr:hover{ background:#fff8f8; }
.hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="container" aria-live="polite">
    <div class="logo"><img src="Acciona_logo.svg.png" alt="Logo de Acciona" /></div>
    <h1>TIC Tranversales</h1>

    <div class="form-row">
      <div class="form-group">
        <label for="company">Empresa</label>
        <select id="company" aria-label="Empresa">
          <option value="" selected>‚Äî Selecciona empresa ‚Äî</option>
          <option value="Acciona Energ√≠a">Acciona Energ√≠a</option>
          <option value="Nfq">Nfq</option>
        </select>
      </div>
      <div class="form-group">
        <label for="workDate">Fecha</label>
        <input type="date" id="workDate" aria-label="Fecha" />
      </div>
      <div class="form-group">
        <label for="numPeople">N√∫mero de personas</label>
        <input type="number" id="numPeople" min="1" value="1" aria-label="N√∫mero de personas" />
        <div id="hoursSummary" class="summary" style="margin-top:8px;">Horas totales: <strong id="totalHours">0</strong> / M√°ximo: <strong id="maxHours">8</strong></div>
      </div>
    </div>

    <div id="activitiesContainer"></div>

    <div class="actions-bar">
      <button class="btn" id="btnAdd" title="A√±adir actividad (Enter)" onclick="addActivityBlock()">‚ûï A√±adir actividad</button>
      <button class="btn" id="btnSave" title="Guardar (Ctrl+S)" onclick="validateAndSave()">üíæ Guardar Registro</button>
	  <button type="button" id="cancelEditBtn" class="btn-ghost hidden" onclick="cancelEdit()">Cancelar edici√≥n</button>

      <div id="formError" class="error">‚ö†Ô∏è Revisa los campos marcados o la suma de horas.</div>
    </div>

<h2 style="margin: 22px 0 8px;">Registros</h2>
<div class="table-wrap">
  <table class="table" aria-label="Tabla de registros">
    <thead>
	  <tr>
	    <th>Empresa</th>
		<th>Cartera</th>
	    <th>Fecha</th>
	    <th>Actividad</th>
	    <th>C√≥digo de demanda</th>
	    <th>Tarea</th>
	    <th>Asunto</th>
	    <th style="text-align:right;">Horas</th>
	    <th>Acciones</th>
	  </tr>
	</thead>
	<tbody id="entriesTbody">
	  <tr><td colspan="9">No hay registros.</td></tr>
	</tbody>
    <tfoot>
      <tr>
        <td colspan="7" style="text-align:right;">Total</td>
        <td id="entriesTotal" style="text-align:right;">0.00</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</div>
<div id="feedback" role="status" aria-live="assertive"></div>

<script>
// URL de tu Web App de Google Apps Script
window.GSHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxXFXpSMpmWJT7OJDYaUK416WGNwujWpGVpYpQpPXsqgmz4oOE7gIUEjgI-YLFsHOiW/exec";

const SUBTASKS = {
  Soporte: ['Revisi√≥n tickets', 'Atenci√≥n telef√≥nica', 'Incidencias'],
  Calidad: ['Auditor√≠a interna', 'Indicadores', 'Documentaci√≥n']
};

let timeEntries = [];
let activityCount = 0;
let editingIndex = null;       // null = creaci√≥n, n√∫mero = edici√≥n
let editingOriginalId = null;  // (si en el futuro guardas IDs de Sheets)
let DEMAND_CODES = [];
const ACTIVITY_OPTIONS = [
  'Delivery',
  'Soporte',
  'Proveedores',
  'Operaciones',
  'Econ√≥micas',
  'Calidad',
  'Coordinaci√≥n',
  'Demanda'
];

const CARTERAS = [
  'Global','EN.Asesoria Jur√≠dica','EN.Calidad y Seguridad','EN.Data&AI',
  'EN.Desarrollo Corporativo y Estrategia','EN.Financiero - Finanzas',
  'EN.Innovaci√≥n','EN.Marketing','EN.Oficina de Estudios CEO','EN.QSE','EN.RRHH',
  'EN.Seguridad','EN.Sostenibilidad','EN.Supply Chain',
  'EN.TIC - Aplicaciones','EN.TIC - Arq. Tecnol√≥gica y Gobierno IT','EN.TIC - Comunicaciones',
  'EN.TIC - Demanda','EN.TIC - Infraestructuras','EN.TIC - Puesto de Usuario','EN.TIC - Servicios de Usuario'
];

function fillOptions(selectEl, options){
  const placeholder = '<option value="" selected>‚Äî Selecciona ‚Äî</option>';
  selectEl.innerHTML = placeholder + (options || []).map(v => `<option value="${v}">${v}</option>`).join('');
}
	
    // Helpers UI
    function showFeedback(message){
      const box = document.getElementById('feedback');
      box.textContent = message;
      box.classList.add('visible');
      setTimeout(()=> box.classList.remove('visible'), 2500);
    }
    function showError(msg){
      const box = document.getElementById('formError');
      box.textContent = '‚ö†Ô∏è ' + msg;
      box.style.display = 'block';
    }
    function hideError(){
      const box = document.getElementById('formError');
      if (!box) return; box.style.display = 'none';
    }

    // Crear bloque de actividad (con prefill opcional)
    function createActivityBlock(prefill){
	  activityCount++;
	  const container = document.getElementById('activitiesContainer');
	  const block = document.createElement('div');
	  block.className = 'activity-block';
	  block.id = `activity-${activityCount}`;
	  block.innerHTML = `
	    <h3><span class="badge">üìå Actividad ${activityCount}</span></h3>
	    <div class="form-row" style="align-items:flex-end;">
	
	      <div class="form-group" style="flex:0 1 190px; min-width:160px;">
	        <label>Actividad</label>
	        <select class="activity" aria-label="Actividad" onchange="onActivityChange(this)">
	          <option value="" selected>‚Äî Selecciona actividad ‚Äî</option>
	          ${ACTIVITY_OPTIONS.map(a => `<option value="${a}">${a}</option>`).join('')}
	        </select>
	      </div>
	
	      <div class="form-group" style="flex:0 1 200px; min-width:160px;">
	        <label>Cartera</label>
	        <select class="portfolio" aria-label="Cartera">
	          ${CARTERAS.map(v => `<option value="${v}">${v}</option>`).join('')}
	        </select>
	      </div>
	
	      <div class="form-group" style="flex:0 1 180px; min-width:160px;">
	        <label>C√≥digo de demanda</label>
	        <select class="demand" aria-label="C√≥digo de demanda" onchange="onDemandChange(this)" disabled>
	          <option value="" selected>‚Äî Selecciona c√≥digo ‚Äî</option>
	        </select>
	      </div>
	
	      <div class="form-group" style="flex:0 1 220px; min-width:180px;">
	        <label>Tarea</label>
	        <select class="task" aria-label="Tarea" onchange="updateTarea(this)" disabled>
	          <option value="" selected>‚Äî Selecciona tarea ‚Äî</option>
	        </select>
	      </div>
	
	      <div class="form-group" style="flex:2 1 320px;">
	        <label>Asunto</label>
	        <input type="text" class="subject" aria-label="Asunto" />
	      </div>
	
	      <div class="form-group" style="max-width:140px;">
	        <label>Horas</label>
	        <input type="number" class="hours" min="0" step="0.25" aria-label="Horas" />
	      </div>
	
	      <div class="form-group" style="flex:0 0 120px; text-align:right;">
	        <button type="button" class="btn-secondary" title="Eliminar actividad"
	          onclick="this.closest('.activity-block').remove(); recalcHours();">üóë Eliminar</button>
	      </div>
	    </div>`;
	
	  container.appendChild(block);
	
	  // Inicializar seg√∫n gen√©ricas
	  const activitySelect = block.querySelector('.activity');
	  onActivityChange(activitySelect);
	
	
	
			// ===== PREFILL (si viene de editar) =====
		if (prefill && typeof prefill === 'object'){
		  // 1) Actividad
		  if (prefill.activity){
		    activitySelect.value = prefill.activity;
		    onActivityChange(activitySelect);
		  }
		  // 2) Cartera
		  const portfolio = block.querySelector('.portfolio');
		  if (portfolio && prefill.cartera){
		    const opt = [...portfolio.options].find(o => o.value === prefill.cartera);
		    if (!opt){
		      portfolio.insertAdjacentHTML('beforeend', `<option value="${prefill.cartera}">${prefill.cartera}</option>`);
		    }
		    portfolio.value = prefill.cartera;
		  }
		  // 3) C√≥digo de demanda (si actividad=Delivery) y asunto por mapeo
		  const demandSelect = block.querySelector('.demand');
		  const subjectInput = block.querySelector('.subject');
		  if (demandSelect && prefill.demand){
		    if (Array.isArray(window.DEMAND_CODES) && window.DEMAND_CODES.length){
		      fillOptions(demandSelect, window.DEMAND_CODES);
		      demandSelect.disabled = false;
		    }
		    demandSelect.value = prefill.demand;
		    onDemandChange(demandSelect);
		  }
		  // 4) Tarea (si procede)
		  const taskSelect = block.querySelector('.task');
		  if (taskSelect){
		    if (prefill.task){
		      // aseg√∫rate de que exista como opci√≥n
		      const exists = [...taskSelect.options].some(o => (o.value === prefill.task || o.text === prefill.task));
		      if (!exists){
		        taskSelect.insertAdjacentHTML('beforeend', `<option value="${prefill.task}">${prefill.task}</option>`);
		      }
		      taskSelect.value = prefill.task;
		      taskSelect.disabled = false; // si est√°s editando, se supone que es v√°lida
		    } else if (prefill.taskId){
		      taskSelect.value = prefill.taskId;
		      taskSelect.disabled = false;
		    }
		  }
		  // 5) Asunto (si no lo rellen√≥ el mapeo)
		  if (subjectInput){
		    if (prefill.subject){
		      subjectInput.value = prefill.subject;
		      // si viene de mapeo, puede estar readOnly; en edici√≥n lo dejamos editable:
		      subjectInput.readOnly = false;
		    }
		  }
		  // 6) Horas
		  const hoursEl = block.querySelector('.hours');
		  if (hoursEl && prefill.hours != null){
		    hoursEl.value = prefill.hours;
		  }
		}
	}

function addActivityBlock(){ createActivityBlock(); }


function onActivityChange(selectEl){
  const parent       = selectEl.closest('.activity-block');
  const demandSelect = parent.querySelector('.demand');
  const taskSelect   = parent.querySelector('.task');
  const subjectInput = parent.querySelector('.subject');

  // reset b√°sico
  fillOptions(taskSelect, []);
  fillOptions(demandSelect, []);
  taskSelect.disabled   = true;
  demandSelect.disabled = true;
  subjectInput.readOnly = false;
  subjectInput.value    = '';

  const v = selectEl.value;

  switch (v) {
	case 'Delivery': {
	  const hydrate = () => {
	    fillOptions(demandSelect, window.DEMAND_CODES);
	    demandSelect.disabled = false;
	    // asunto se bloquear√° al elegir demanda si hay mapeo
	  };
	
	  if (Array.isArray(window.DEMAND_CODES) && window.DEMAND_CODES.length > 0) {
	    hydrate();
	  } else {
	    demandSelect.disabled = true;
	    demandSelect.innerHTML = '<option value="">Cargando c√≥digos‚Ä¶</option>';
	    window.addEventListener('demandcodes:ready', hydrate, { once:true });
	  }
	  break;
	}


    case 'Soporte':
	  // Tarea habilitada (3 opciones), C√≥digo de demanda deshabilitado, Asunto libre
	  taskSelect.disabled   = false;
	  fillOptions(taskSelect, SUBTASKS.Soporte);
	
	  demandSelect.disabled = true;
	  fillOptions(demandSelect, []);
	
	  subjectInput.readOnly = false;
	  break;

    case 'Proveedores':
      // Todo bloqueado salvo Asunto libre
      taskSelect.disabled   = true;
      demandSelect.disabled = true;
      subjectInput.readOnly = false;
      break;

    case 'Operaciones':
    case 'Econ√≥micas':
    case 'Coordinaci√≥n':
      // Tarea y C√≥digo de demanda deshabilitados, Asunto libre
      taskSelect.disabled   = true;
      demandSelect.disabled = true;
      subjectInput.readOnly = false;
      break;

    case 'Calidad':
      // Tarea habilitada (3 opciones), C√≥digo de demanda deshabilitado, Asunto libre
      taskSelect.disabled   = false;
      fillOptions(taskSelect, SUBTASKS.Calidad);
      demandSelect.disabled = true;
      subjectInput.readOnly = false;
      break;

	case 'Demanda': {
	  const block        = selectEl.closest('.activity-block');
	  const taskSelect   = block.querySelector('.task');
	  const demandSelect = block.querySelector('.demand');
	  const subjectInput = block.querySelector('.subject');
	
	  // Deshabilitar demanda y tarea; asunto libre
	  taskSelect && (taskSelect.disabled = true);
	  if (demandSelect) {
	    demandSelect.disabled = true;
	    demandSelect.innerHTML = '<option value="">‚Äî Selecciona c√≥digo ‚Äî</option>';
	  }
	  subjectInput && (subjectInput.readOnly = false);
	  break;
	  }
	}
}
	
	function onDemandChange(selectEl){
	  const parent       = selectEl.closest('.activity-block');
	  const activity     = parent.querySelector('.activity').value;
	  const subjectInput = parent.querySelector('.subject');
	  const code         = selectEl.value || '';
	
	  // Si hay mapeo en CodigosDemanda, usarlo
	  const mapped = (window.DEMAND_MAP && window.DEMAND_MAP[code]) || '';
	
	  if (activity === 'Delivery') {
	    subjectInput.value   = mapped || '';
	    subjectInput.readOnly = !!mapped; // bloquear solo cuando existe mapeo
	  } else {
	    // Para otras actividades, dejamos asunto libre
	    if (mapped) subjectInput.value = mapped; // opci√≥n: sugerir si existe coincidencia
	    subjectInput.readOnly = false;
	  }
	}



 // Limpia el formulario para una nueva captura
    function resetFormAfterSave(){
      const companyEl = document.getElementById('company');
      const dateEl = document.getElementById('workDate');
      const peopleEl = document.getElementById('numPeople');
      const actsEl = document.getElementById('activitiesContainer');
      if (companyEl) companyEl.value = '';
      if (dateEl) dateEl.value = new Date().toISOString().split('T')[0];
      if (peopleEl) peopleEl.value = 1;
      if (actsEl) actsEl.innerHTML = '';
      if (typeof activityCount !== 'undefined') activityCount = 0;
      if (typeof createActivityBlock === 'function') createActivityBlock();
      if (typeof recalcHours === 'function') recalcHours(0);
      if (typeof hideError === 'function') hideError();
    }

async function validateAndSave() {
  hideError();
  const numPeople = parseInt(document.getElementById('numPeople').value) || 0;
  const maxHours = numPeople * 8;
  let totalHours = 0;

  const activities = Array.from(document.querySelectorAll('.activity-block'));
  const date = document.getElementById('workDate').value;
  const company = document.getElementById('company').value;

  if (!company){ showError('Selecciona la empresa.'); return; }
  if (!date){ showError('Selecciona la fecha.'); return; }

  let hasFieldError = false;
  const records = activities.map(block => {
    const activity = block.querySelector('.activity')?.value || '';
    let demand     = block.querySelector('.demand')?.value || '';
    const cartera  = block.querySelector('.portfolio')?.value || 'Global';

    // Tarea (solo si select no est√° deshabilitado)
    const taskEl = block.querySelector('.task');
    const task   = (taskEl && !taskEl.disabled)
      ? (taskEl.value || (taskEl.options[taskEl.selectedIndex]?.text || ''))
      : '';

	// VALIDACI√ìN: cuando la actividad requiere Tarea, no puede quedar en "‚Äî Selecciona ‚Äî"
	if (activity === 'Soporte' || activity === 'Calidad') {
	  // si el select est√° habilitado pero sin valor (placeholder con value="")
	  const taskIsEmpty = !taskEl || taskEl.disabled || !taskEl.value;
	  if (taskIsEmpty) {
	    hasFieldError = true;
	    if (taskEl) taskEl.style.borderColor = 'var(--error)';
	  } else {
	    if (taskEl) taskEl.style.borderColor = '';
	  }
	} else {
	  // otras actividades: limpia posible rojo previo
	  if (taskEl) taskEl.style.borderColor = '';
	}


    // Reglas nuevas:
    // 1) Si la actividad es "Demanda" => NO se env√≠a c√≥digo de demanda
    if (activity === 'Demanda') {
      demand = '';
    }

    // 2) Si la actividad es "Delivery" => requerir c√≥digo de demanda
    if (activity === 'Delivery' && !demand) {
      hasFieldError = true;
      const demandSelect = block.querySelector('.demand');
      if (demandSelect) demandSelect.style.borderColor = 'var(--error)';
    } else {
      const demandSelect = block.querySelector('.demand');
      if (demandSelect) demandSelect.style.borderColor = '';
    }

    // Asunto: usa input; si viene vac√≠o y hay mapeo por demanda (Delivery), √∫salo
    let subject = block.querySelector('.subject')?.value || '';
    if (!subject && activity === 'Delivery' && window.DEMAND_MAP && demand) {
      subject = window.DEMAND_MAP[demand] || '';
    }

    // Horas
    const hoursEl = block.querySelector('.hours');
    const hours   = parseFloat(hoursEl.value) || 0;

    totalHours += hours;
    if (hours <= 0) { 
      hoursEl.style.borderColor = 'var(--error)'; 
      hasFieldError = true; 
    } else { 
      hoursEl.style.borderColor = ''; 
    }

    // Validar actividad vac√≠a (opcional pero recomendado)
    if (!activity) {
      hasFieldError = true;
      const actEl = block.querySelector('.activity');
      if (actEl) actEl.style.borderColor = 'var(--error)';
    } else {
      const actEl = block.querySelector('.activity');
      if (actEl) actEl.style.borderColor = '';
    }

    return {
      company,
      date,
      num_people: numPeople,
      activity,
      demand,     // ‚Üê quedar√° vac√≠o si actividad === 'Demanda'
      task,
      subject,
      hours,
      cartera     // ‚Üê nuevo campo, va siempre
    };
  });

	 const isEdit = (editingIndex !== null);
	  if (isEdit && records.length !== 1){
	    showError('En modo edici√≥n solo puedes tener una actividad.');
	    return;
	  }



  // Si hubo errores de campo, no enviamos
  if (hasFieldError) {
    showError('Revisa los campos resaltados en rojo.');
    return;
  }
	// BLOQUEO por exceso de horas (suma de actividades > numPersonas*8)
	if (totalHours > maxHours) {
	  recalcHours(totalHours, maxHours); // refresca sem√°foro
	  showError(`La suma de horas (${totalHours.toFixed(2)}) supera el m√°ximo permitido (${maxHours.toFixed(2)}).`);
	  const box = document.getElementById('hoursSummary');
	  if (box) { box.classList.add('bad'); box.classList.remove('ok'); }
	  return;
	}
	
    const btnSave = document.getElementById('btnSave');
	try {
	  if (btnSave) { btnSave.disabled = true; btnSave.textContent = 'Enviando...'; }
	
	  let sendRes;
	if (isEdit){
	  // Env√≠o de UNA fila en modo actualizaci√≥n (incluye id)
	  records[0].id = editingOriginalId;   // <-- imprescindible
	  sendRes = await sendUpdateToSheets(records[0]);
	} else {
	  // Alta m√∫ltiple como antes
	  sendRes = await sendToSheets(records);
	}
	
	if (sendRes.ok){
	  if (isEdit){
	    // Sustituimos la fila editada SOLO tras confirmaci√≥n del servidor
	    const updated = { ...records[0], id: editingOriginalId }; // <-- conserva id
	    timeEntries[editingIndex] = updated;
	    editingIndex = null;
	    editingOriginalId = null;           // <-- limpia el estado
	    toggleEditUI(false);
	  } else {
	    // Altas normales, SOLO tras confirmaci√≥n del servidor
	    // Copiamos los ids devueltos por el backend
	    const ids = (sendRes.data && Array.isArray(sendRes.data.ids)) ? sendRes.data.ids : [];
	    records.forEach((r, i) => { r.id = ids[i] || r.id || null; });
	    timeEntries.push(...records);
	  }
	  updateEntries();
	  recalcHours(totalHours, maxHours);
	  showFeedback('üì§ Guardado en servidor');
	  resetFormAfterSave();
	} else if (sendRes.reason === 'missing_url') {
	  showError('‚ö†Ô∏è Falta configurar la URL del Web App');
	} else if (sendRes.reason === 'network_error') {
	  showError('‚ö†Ô∏è No se pudo conectar con el servidor');
	} else if (sendRes.reason === 'timeout') {
	  showError('‚ö†Ô∏è Sin confirmaci√≥n del servidor (timeout)');
	} else {
	  showError('‚ö†Ô∏è El servidor no confirm√≥ el guardado');
	  console.log('Diagn√≥stico env√≠o:', sendRes);
	}

	} catch (err) {
	  console.error(err);
	  showError('‚ö†Ô∏è Error inesperado al guardar');
	} finally {
	  if (btnSave) { btnSave.disabled = false; btnSave.textContent = 'üíæ Guardar Registro'; }
	}
 }


    // Env√≠o sin CORS: form + iframe (robusto: autocrea DOM si falta)
    function ensureSheetsTransport(urlValue){
      let iframe = document.getElementById('sheets_target');
      if (!iframe){
        iframe = document.createElement('iframe');
        iframe.name = 'sheets_target';
        iframe.id = 'sheets_target';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
      }
      let form = document.getElementById('sheets-form');
      if (!form){
        form = document.createElement('form');
        form.id = 'sheets-form';
        form.method = 'POST';
        form.target = 'sheets_target';
        form.style.display = 'none';
        document.body.appendChild(form);
      }
      let urlInput = document.getElementById('sheets-url');
      if (!urlInput){
        urlInput = document.createElement('input');
        urlInput.type = 'hidden';
        urlInput.id = 'sheets-url';
        form.appendChild(urlInput);
      }
      if (urlValue) urlInput.value = urlValue;

      let recInput = document.getElementById('sheets-records');
      if (!recInput){
        recInput = document.createElement('input');
        recInput.type = 'hidden';
        recInput.name = 'records';
        recInput.id = 'sheets-records';
        form.appendChild(recInput);
      }
      return { iframe, form, urlInput, recInput };
    }

    // --- Google Sheets ---
async function sendToSheets(records){
  const url = window.GSHEET_WEBAPP_URL;
  if (!url || !/^https:\/\/script\.google\.com\/macros\//.test(url)) {
    return { ok:false, reason:'missing_url' };
  }
  const body = new URLSearchParams({ records: JSON.stringify(records) });
  try {
    const res  = await fetch(url, { method:'POST', body });
    const data = await res.json().catch(()=> ({}));
    return { ok: !!(data && data.ok), data, status: res.status };
  } catch (err) {
    return { ok:false, reason:'network_error', error: err };
  }
}

async function sendUpdateToSheets(entry){
  const url = window.GSHEET_WEBAPP_URL;
  if (!url || !/^https:\/\/script\.google\.com\/macros\//.test(url)) {
    return { ok:false, reason:'missing_url' };
  }
  // IMPORTANTE: para que realmente actualice en Sheets, tu Apps Script debe
  // reconocer 'mode=update' y el contenido de 'entry'. Ajusta all√≠.
  const body = new URLSearchParams({
    mode: 'update',
    entry: JSON.stringify(entry)
    // si en el futuro manejas un ID de fila: id: entry.id
  });
  try {
    const res  = await fetch(url, { method:'POST', body });
    const data = await res.json().catch(()=> ({}));
    return { ok: !!(data && data.ok), data, status: res.status };
  } catch (err) {
    return { ok:false, reason:'network_error', error: err };
  }
}

async function sendDeleteToSheets(id){
  const url = window.GSHEET_WEBAPP_URL;
  if (!url || !/^https:\/\/script\.google\.com\/macros\//.test(url)) {
    return { ok:false, reason:'missing_url' };
  }
  const body = new URLSearchParams({
    mode: 'delete',
    id: id
  });
  try {
    const res  = await fetch(url, { method:'POST', body });
    const data = await res.json().catch(()=> ({}));
    return { ok: !!(data && data.ok), data, status: res.status };
  } catch (err) {
    return { ok:false, reason:'network_error', error: err };
  }
}

    // --- Resumen de horas ---
    function recalcHours(passedTotal, passedMax){
      const numPeople = parseInt(document.getElementById('numPeople').value) || 0;
      const max = passedMax ?? numPeople * 8;
      const total = passedTotal ?? Array.from(document.querySelectorAll('.hours')).reduce((s, el)=> s + (parseFloat(el.value)||0), 0);
      document.getElementById('totalHours').textContent = total.toFixed(2);
      document.getElementById('maxHours').textContent = max.toFixed(2);
      const box = document.getElementById('hoursSummary');
      box.classList.toggle('ok', total <= max);
      box.classList.toggle('bad', total > max);
    }

    // --- Tabla de registros ---
    function updateEntries(){
      const tbody = document.getElementById('entriesTbody');
      const totalCell = document.getElementById('entriesTotal');
      if (!tbody) return;

      if (!timeEntries.length){
        tbody.innerHTML = '<tr><td colspan="9">No hay registros.</td></tr>';
        if (totalCell) totalCell.textContent = '0.00';
        return;
      }

      const total = timeEntries.reduce((s,e)=> s + (parseFloat(e.hours)||0), 0).toFixed(2);
      tbody.innerHTML = timeEntries.map((e, idx)=> `
	  <tr>
	    <td>${e.company || ''}</td>
		<td>${e.cartera || 'Global'}</td>
	    <td>${e.date || ''}</td>
	    <td>${e.activity || '‚Äî'}</td>
	    <td>${e.demand || '‚Äî'}</td>
	    <td>${e.task || '‚Äî'}</td>
	    <td>${e.subject || '‚Äî'}</td>
	    <td style="text-align:right; white-space:nowrap;">${e.hours}</td>
	    <td style="white-space:nowrap;">
	      <button class="btn-secondary" title="Editar" onclick="editEntry(${idx})">‚úè</button>
	      <button class="btn-secondary" title="Eliminar" onclick="deleteEntry(${idx})">üóë</button>
	    </td>
	  </tr>`).join('');
      if (totalCell) totalCell.textContent = total;
    }

	function editEntry(idx){
	  const rec = timeEntries[idx];
	  if (!rec) return;
	
	  // Guardamos qu√© fila estamos editando
	  editingIndex = idx;
	  editingOriginalId = rec.id || null;
	
	  // Rellena cabecera
	  const companyEl = document.getElementById('company');
	  const dateEl    = document.getElementById('workDate');
	  const peopleEl  = document.getElementById('numPeople');
	  if (companyEl) companyEl.value = rec.company || '';
	  if (dateEl)    dateEl.value    = rec.date || new Date().toISOString().split('T')[0];
	  if (peopleEl)  peopleEl.value  = rec.num_people || 1;
	
	  // Limpia actividades y crea UNA con prefill
	  const actsEl = document.getElementById('activitiesContainer');
	  if (actsEl) actsEl.innerHTML = '';
	  if (typeof activityCount !== 'undefined') activityCount = 0;
	
	  createActivityBlock({
	    activity: rec.activity || '',
	    cartera:  rec.cartera  || 'Global',
	    demand:   rec.demand   || '',
	    task:     rec.task     || '',
	    subject:  rec.subject  || '',
	    hours:    rec.hours    || 0
	  });
		
	  recalcHours();
		
	  toggleEditUI(true);
	  showFeedback('‚úè Registro cargado para edici√≥n');
	  window.scrollTo({ top: 0, behavior:'smooth' });
	}


	async function deleteEntry(idx){
	  const rec = timeEntries[idx];
	  if (!rec) return;
	
	  // Validaciones
	  if (!rec.id) {
	    // Registro antiguo sin ID: no podemos borrar de forma segura
	    showError('Este registro no tiene ID en Sheets. No se puede eliminar autom√°ticamente.');
	    return;
	  }
	
	  const okAsk = confirm('¬øEliminar este registro definitivamente?');
	  if (!okAsk) return;
	
	  // Llamada al backend
	  try {
	    const delRes = await sendDeleteToSheets(rec.id);
	    if (!delRes.ok) {
	      if (delRes.reason === 'missing_url') {
	        showError('‚ö†Ô∏è Falta configurar la URL del Web App');
	      } else if (delRes.reason === 'network_error') {
	        showError('‚ö†Ô∏è No se pudo conectar con el servidor');
	      } else if (delRes.data && delRes.data.error === 'not_found') {
	        showError('‚ö†Ô∏è ID no encontrado en Sheets (ya estaba eliminado o no existe).');
	      } else {
	        showError('‚ö†Ô∏è El servidor no confirm√≥ el borrado');
	        console.log('Diagn√≥stico borrado:', delRes);
	      }
	      return;
	    }
	
	    // Si el servidor confirm√≥, ahora s√≠ eliminamos en la UI
	    timeEntries.splice(idx, 1);
	    updateEntries();
	    showFeedback('üóë Registro eliminado');
	  } catch (err) {
	    console.error(err);
	    showError('‚ö†Ô∏è Error inesperado al eliminar');
	  }
	}


  // Hook que recibe la lista desde Apps Script
	function populateDemandCodes(list){
	  window.DEMAND_CODES = [];
	  window.DEMAND_MAP   = {};
	  (Array.isArray(list) ? list : []).forEach(item => {
	    const code = item.Demanda || item.demanda || item.code || '';
	    const subj = item.Asunto  || item.asunto  || item.subject || '';
	    if (code) {
	      window.DEMAND_CODES.push(code);
	      window.DEMAND_MAP[code] = subj || '';
	    }
	  });
	
	  console.log('DEMAND_CODES cargados:', window.DEMAND_CODES.length);
	  window.dispatchEvent(new CustomEvent('demandcodes:ready'));
	
	  document.querySelectorAll('.activity-block').forEach(block => {
	    const activity = block.querySelector('.activity')?.value;
	    if (activity === 'Delivery') {
	      const demandSelect = block.querySelector('.demand');
	      const subjectInput = block.querySelector('.subject');
	      fillOptions(demandSelect, window.DEMAND_CODES);
	      demandSelect.disabled = false;
	      const code = demandSelect.value || '';
	      subjectInput.value   = (window.DEMAND_MAP[code] || '');
	      subjectInput.readOnly = !!subjectInput.value;
	    }
	  });
	}

	function cancelEdit(){
	  editingIndex = null;
	  editingOriginalId = null; 
	  toggleEditUI(false);
	  const actsEl = document.getElementById('activitiesContainer');
	  if (actsEl) actsEl.innerHTML = '';
	  if (typeof activityCount !== 'undefined') activityCount = 0;
	  createActivityBlock();
	  const dateEl = document.getElementById('workDate');
	  if (dateEl) dateEl.value = new Date().toISOString().split('T')[0];
	  const peopleEl = document.getElementById('numPeople');
	  if (peopleEl) peopleEl.value = 1;
	}

 // Crear el primer bloque al cargar y configurar escuchas
  document.addEventListener('DOMContentLoaded', () => {
    // fecha por defecto
    const dateEl = document.getElementById('workDate');
    if (dateEl) dateEl.value = new Date().toISOString().split('T')[0];

    // crea el primer bloque de actividad
    createActivityBlock();

    // UI de horas
    recalcHours();
    const peopleEl = document.getElementById('numPeople');
    if (peopleEl) peopleEl.addEventListener('input', () => recalcHours());
    const actsEl = document.getElementById('activitiesContainer');
    if (actsEl) actsEl.addEventListener('input', (e) => {
      if (e.target.classList.contains('hours')) recalcHours();
    });
	toggleEditUI(false);
  });

  // Asegura que las funciones referenciadas en atributos HTML existan en window

// Asegura que las funciones referenciadas en atributos HTML existan en window
window.addActivityBlock  = addActivityBlock;
window.validateAndSave   = validateAndSave;
window.onActivityChange  = onActivityChange;
window.onDemandChange    = onDemandChange;

// Si usas la versi√≥n con updateTasks / updateTarea (v2), exp√≥rtalas si existen
if (typeof updateTasks === 'function')  window.updateTasks  = updateTasks;
if (typeof updateTarea === 'function')  window.updateTarea  = updateTarea;

// Compatibilidad: si el HTML a√∫n llama onTaskChange, apunta al alias correcto
if (typeof onTaskChange === 'function') { 
  window.onTaskChange = onTaskChange; 
} else if (typeof updateTarea === 'function') { 
  window.onTaskChange = updateTarea; 
}

// (Opcional) para el loader JSONP de c√≥digos
if (typeof populateDemandCodes === 'function') window.populateDemandCodes = populateDemandCodes;

async function loadCodes(){
  const url = window.GSHEET_WEBAPP_URL + '?resource=codes&_=' + Date.now();
  try {
    const res  = await fetch(url, { cache: 'no-store' });
    const text = await res.text();

    // 1) intenta JSON puro
    try {
      const json = JSON.parse(text);
      if (json && json.ok && Array.isArray(json.list)) {
        if (typeof populateDemandCodes === 'function') populateDemandCodes(json.list);
        return;
      }
    } catch (_) { /* no es JSON, intentamos JSONP */ }

    // 2) compat: JSONP ‚Üí extrae el array dentro de populateDemandCodes(...)
    const m = text.match(/populateDemandCodes\s*\(\s*([\s\S]*?)\s*\)\s*;?\s*$/);
    if (m) {
      const list = JSON.parse(m[1]);
      if (typeof populateDemandCodes === 'function') populateDemandCodes(list);
      return;
    }

    console.warn('Respuesta inesperada al cargar c√≥digos:', text.slice(0,120));

  } catch (err) {
    console.error('Error cargando c√≥digos', err);
  }
}
document.addEventListener('DOMContentLoaded', loadCodes);
	
  function $(sel){ return document.querySelector(sel); }
  function setVal(sel, v){ const el=$(sel); if(el) el.value = (v ?? ''); }

  // Para selects o inputs con datalist. Si el valor no existe en el select, lo crea.
  function setSelectOrDatalist(sel, v){
    const el = $(sel); if(!el) return;
    if (el.tagName === 'SELECT'){
      const opt = [...el.options].find(o => (o.value == v || o.text == v));
      if (opt) el.value = opt.value;
      else {
        const o = new Option(v, v, true, true);
        el.add(o); el.value = v;
      }
    } else {
      el.value = v ?? '';
    }
  }

function toggleEditUI(on){
  const saveBtn   = document.getElementById('btnSave');
  const cancelBtn = document.getElementById('cancelEditBtn');
  if (!saveBtn || !cancelBtn) return;
  if (on){
    saveBtn.textContent = 'Guardar cambios';
    cancelBtn.classList.remove('hidden');
  } else {
    saveBtn.textContent = 'üíæ Guardar Registro';
    cancelBtn.classList.add('hidden');
  }
}
</script>
</body>
</html>